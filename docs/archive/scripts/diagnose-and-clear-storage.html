<!DOCTYPE html>
<html>
<head>
    <title>Diagnose & Clear Storage</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 900px; margin: 0 auto; background: #2a2a2a; padding: 30px; border-radius: 10px; }
        button { background: #0066cc; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0052a3; }
        button.danger { background: #cc0000; }
        button.danger:hover { background: #aa0000; }
        .success { background: #00cc44; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .error { background: #cc0000; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .info { background: #333; padding: 15px; border-radius: 5px; margin: 15px 0; font-family: monospace; white-space: pre-wrap; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .warning { background: #ff9900; color: #000; padding: 15px; border-radius: 5px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnose & Clear Storage</h1>
        <p>This tool will help identify why registration is failing.</p>

        <div id="output"></div>

        <button onclick="diagnose()">üîç Diagnose Storage</button>
        <button onclick="clearAll()" class="danger">üóëÔ∏è Clear ALL Storage</button>
        <button onclick="location.href='http://localhost:3000'">‚ÜóÔ∏è Go to App</button>
    </div>

    <script>
        function output(message, type = 'info') {
            const div = document.getElementById('output')
            div.innerHTML = `<div class="${type}">${message}</div>`
        }

        function diagnose() {
            let report = 'üìä STORAGE DIAGNOSTIC REPORT\n'
            report += '='.repeat(60) + '\n\n'

            // Check systemUsers
            const systemUsers = localStorage.getItem('systemUsers')
            if (systemUsers) {
                try {
                    const users = JSON.parse(systemUsers)
                    report += `‚ö†Ô∏è  FOUND: systemUsers (${users.length} user(s))\n`
                    users.forEach((u, i) => {
                        report += `   ${i + 1}. ${u.email} - ${u.role}\n`
                    })
                    report += '\n'
                } catch (e) {
                    report += '‚ùå ERROR: systemUsers exists but cannot parse\n\n'
                }
            } else {
                report += '‚úÖ systemUsers: Not found\n\n'
            }

            // Check userProfile_ keys
            const userProfileKeys = Object.keys(localStorage).filter(k => k.startsWith('userProfile_'))
            if (userProfileKeys.length > 0) {
                report += `‚ö†Ô∏è  FOUND: ${userProfileKeys.length} userProfile_* key(s)\n`
                userProfileKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key))
                        report += `   - ${key}: ${data.email || 'unknown'}\n`
                    } catch (e) {
                        report += `   - ${key}: (parse error)\n`
                    }
                })
                report += '\n'
            } else {
                report += '‚úÖ userProfile_*: Not found\n\n'
            }

            // Check currentUser
            const currentUser = localStorage.getItem('currentUser')
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser)
                    report += `‚ö†Ô∏è  FOUND: currentUser\n`
                    report += `   Email: ${user.email}\n`
                    report += `   Role: ${user.role}\n\n`
                } catch (e) {
                    report += '‚ùå currentUser exists but cannot parse\n\n'
                }
            } else {
                report += '‚úÖ currentUser: Not found\n\n'
            }

            // List all keys
            report += 'üìã ALL LOCALSTORAGE KEYS:\n'
            report += '-'.repeat(60) + '\n'
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i)
                const value = localStorage.getItem(key)
                report += `${i + 1}. ${key} (${value.length} chars)\n`
            }
            report += '\nTotal keys: ' + localStorage.length

            output(report, 'info')
        }

        function clearAll() {
            if (!confirm('‚ö†Ô∏è  This will delete ALL localStorage data. Are you sure?')) {
                return
            }

            let report = 'üóëÔ∏è  CLEARING ALL STORAGE...\n\n'

            // Get count before
            const beforeCount = localStorage.length
            report += `Before: ${beforeCount} localStorage keys\n\n`

            // Clear everything
            localStorage.clear()
            sessionStorage.clear()

            // Verify
            const afterCount = localStorage.length
            report += `After: ${afterCount} localStorage keys\n\n`

            if (afterCount === 0) {
                report += '‚úÖ SUCCESS! All storage cleared.\n\n'
                report += 'üìã Next steps:\n'
                report += '1. Click "Go to App" button below\n'
                report += '2. Try registering again\n'
                report += '3. You should be the first user\n'

                output(report, 'success')

                // Auto-redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = 'http://localhost:3000'
                }, 3000)
            } else {
                report += '‚ö†Ô∏è  WARNING: Some keys remain:\n'
                for (let i = 0; i < localStorage.length; i++) {
                    report += `   ${localStorage.key(i)}\n`
                }
                output(report, 'warning')
            }
        }

        // Auto-run diagnosis on load
        window.addEventListener('load', () => {
            setTimeout(diagnose, 500)
        })
    </script>
</body>
</html>
