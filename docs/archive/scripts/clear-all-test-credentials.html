<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clear ALL Test Credentials - Phaeton AI CRM</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 30px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      font-weight: bold;
    }
    button:hover {
      background: #c82333;
    }
    button.info {
      background: #007bff;
    }
    button.info:hover {
      background: #0056b3;
    }
    #output {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 4px;
      min-height: 200px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
    }
    .log-error {
      color: #dc3545;
      font-weight: bold;
    }
    .log-success {
      color: #28a745;
      font-weight: bold;
    }
    .log-warning {
      color: #ffc107;
    }
    .log-info {
      color: #007bff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Clear ALL Test Credentials - Phaeton AI CRM</h1>

    <div class="warning">
      <strong>‚ö†Ô∏è WARNING:</strong> This will remove ALL test credentials and credential backups from your browser storage.
      <br><br>
      <strong>What this does:</strong>
      <ul>
        <li>Clears sessionStorage credential backups</li>
        <li>Clears memory backups (window object)</li>
        <li>Clears emergency credential backups</li>
        <li>Removes any test credentials from ALL localStorage settings</li>
        <li>Preserves ONLY your real API keys if you configured them</li>
      </ul>
    </div>

    <div class="success" id="successMessage">
      <strong>‚úÖ Success!</strong> All test credentials have been cleared!
      <br>
      <strong>Next steps:</strong>
      <ol>
        <li>Close this page</li>
        <li>Refresh Phaeton AI CRM (Ctrl+R or F5)</li>
        <li>Go to Settings > API Configuration</li>
        <li>Enter your REAL API keys and Agent IDs</li>
        <li>Click Save</li>
      </ol>
    </div>

    <div style="margin-top: 20px;">
      <button id="scanBtn" class="info">üîç Scan for Test Credentials</button>
      <button id="clearBtn">üóëÔ∏è Clear ALL Test Credentials</button>
    </div>

    <div id="output">
      <p>Click "Scan" to detect test credentials...</p>
    </div>
  </div>

  <script>
    const output = document.getElementById('output');
    const scanBtn = document.getElementById('scanBtn');
    const clearBtn = document.getElementById('clearBtn');
    const successMessage = document.getElementById('successMessage');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log-entry log-${type}`;
      div.textContent = message;
      output.appendChild(div);
      console.log(message);
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    function scanForTestCredentials() {
      clearOutput();
      log('üîç Scanning for test credentials...', 'info');

      let foundCount = 0;
      const detectedItems = [];

      // 1. Check sessionStorage
      try {
        const sessionBackup = sessionStorage.getItem('retell_credentials_backup');
        if (sessionBackup) {
          const data = JSON.parse(sessionBackup);
          if (data.apiKey && (data.apiKey.startsWith('test_') || data.apiKey.includes('test'))) {
            foundCount++;
            detectedItems.push('sessionStorage: retell_credentials_backup');
            log('‚ùå Found test credential in sessionStorage backup', 'error');
          }
        }
      } catch (e) {
        log('‚ö†Ô∏è Error scanning sessionStorage: ' + e.message, 'warning');
      }

      // 2. Check memory backup
      try {
        const memoryBackup = window.__retellCredentialsBackup;
        if (memoryBackup && memoryBackup.apiKey) {
          if (memoryBackup.apiKey.startsWith('test_') || memoryBackup.apiKey.includes('test')) {
            foundCount++;
            detectedItems.push('memory: __retellCredentialsBackup');
            log('‚ùå Found test credential in memory backup', 'error');
          }
        }
      } catch (e) {
        log('‚ö†Ô∏è Error scanning memory backup: ' + e.message, 'warning');
      }

      // 3. Check localStorage emergency backups
      try {
        const emergencyBackup = localStorage.getItem('__emergencyRetellCredentials');
        if (emergencyBackup) {
          const data = JSON.parse(emergencyBackup);
          if (data.apiKey && (data.apiKey.startsWith('test_') || data.apiKey.includes('test'))) {
            foundCount++;
            detectedItems.push('localStorage: __emergencyRetellCredentials');
            log('‚ùå Found test credential in emergency backup', 'error');
          }
        }
      } catch (e) {
        log('‚ö†Ô∏è Error scanning emergency backup: ' + e.message, 'warning');
      }

      // 4. Check ALL localStorage settings_* keys
      try {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('settings_')) {
            const value = localStorage.getItem(key);
            if (value) {
              try {
                const settings = JSON.parse(value);

                const hasTestApiKey = settings.retellApiKey && (settings.retellApiKey.startsWith('test_') || settings.retellApiKey.includes('test'));
                const hasTestCallAgent = settings.callAgentId && (settings.callAgentId.startsWith('test_') || settings.callAgentId.includes('test'));
                const hasTestSmsAgent = settings.smsAgentId && (settings.smsAgentId.startsWith('test_') || settings.smsAgentId.includes('test'));

                if (hasTestApiKey || hasTestCallAgent || hasTestSmsAgent) {
                  foundCount++;
                  detectedItems.push(`localStorage: ${key}`);
                  log(`‚ùå Found test credentials in ${key}:`, 'error');
                  if (hasTestApiKey) log(`   - Test API Key: ${settings.retellApiKey}`, 'error');
                  if (hasTestCallAgent) log(`   - Test Call Agent: ${settings.callAgentId}`, 'error');
                  if (hasTestSmsAgent) log(`   - Test SMS Agent: ${settings.smsAgentId}`, 'error');
                }
              } catch (parseError) {
                log(`‚ö†Ô∏è Error parsing ${key}`, 'warning');
              }
            }
          }
        }
      } catch (e) {
        log('‚ö†Ô∏è Error scanning localStorage settings: ' + e.message, 'warning');
      }

      log('', 'info');
      log('='.repeat(80), 'info');
      if (foundCount === 0) {
        log('‚úÖ No test credentials found!', 'success');
      } else {
        log(`‚ö†Ô∏è Found ${foundCount} test credential location(s)`, 'warning');
        log('Detected items:', 'warning');
        detectedItems.forEach(item => log(`  - ${item}`, 'warning'));
      }
      log('='.repeat(80), 'info');
    }

    function clearAllTestCredentials() {
      if (!confirm('Are you sure you want to clear ALL test credentials?\n\nThis will remove all test API keys and fallback credentials.\nYour real credentials (if configured) will be preserved.')) {
        return;
      }

      clearOutput();
      log('üóëÔ∏è Clearing ALL test credentials...', 'info');

      let clearedCount = 0;

      // 1. Clear sessionStorage
      try {
        const sessionBackup = sessionStorage.getItem('retell_credentials_backup');
        if (sessionBackup) {
          sessionStorage.removeItem('retell_credentials_backup');
          clearedCount++;
          log('‚úÖ Cleared sessionStorage backup', 'success');
        }
      } catch (e) {
        log('‚ùå Error clearing sessionStorage: ' + e.message, 'error');
      }

      // 2. Clear memory backup
      try {
        if (window.__retellCredentialsBackup) {
          delete window.__retellCredentialsBackup;
          clearedCount++;
          log('‚úÖ Cleared memory backup', 'success');
        }
      } catch (e) {
        log('‚ùå Error clearing memory backup: ' + e.message, 'error');
      }

      // 3. Clear emergency backups
      try {
        const emergencyBackup = localStorage.getItem('__emergencyRetellCredentials');
        if (emergencyBackup) {
          localStorage.removeItem('__emergencyRetellCredentials');
          clearedCount++;
          log('‚úÖ Cleared emergency backup', 'success');
        }

        const fallbackConfig = localStorage.getItem('__fallbackRetellConfig');
        if (fallbackConfig) {
          localStorage.removeItem('__fallbackRetellConfig');
          clearedCount++;
          log('‚úÖ Cleared fallback config', 'success');
        }
      } catch (e) {
        log('‚ùå Error clearing emergency backups: ' + e.message, 'error');
      }

      // 4. Clear test credentials from ALL settings_* keys
      try {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('settings_')) {
            const value = localStorage.getItem(key);
            if (value) {
              try {
                const settings = JSON.parse(value);
                let modified = false;

                // Remove test API key
                if (settings.retellApiKey && (settings.retellApiKey.startsWith('test_') || settings.retellApiKey.includes('test'))) {
                  delete settings.retellApiKey;
                  modified = true;
                  log(`  - Removed test API key from ${key}`, 'success');
                }

                // Remove test call agent
                if (settings.callAgentId && (settings.callAgentId.startsWith('test_') || settings.callAgentId.includes('test'))) {
                  delete settings.callAgentId;
                  modified = true;
                  log(`  - Removed test call agent from ${key}`, 'success');
                }

                // Remove test SMS agent
                if (settings.smsAgentId && (settings.smsAgentId.startsWith('test_') || settings.smsAgentId.includes('test'))) {
                  delete settings.smsAgentId;
                  modified = true;
                  log(`  - Removed test SMS agent from ${key}`, 'success');
                }

                if (modified) {
                  localStorage.setItem(key, JSON.stringify(settings));
                  clearedCount++;
                }
              } catch (parseError) {
                log(`‚ùå Error processing ${key}`, 'error');
              }
            }
          }
        }
      } catch (e) {
        log('‚ùå Error clearing from localStorage settings: ' + e.message, 'error');
      }

      log('', 'info');
      log('='.repeat(80), 'info');
      log(`‚úÖ Successfully cleared ${clearedCount} test credential location(s)`, 'success');
      log('='.repeat(80), 'info');
      log('', 'info');
      log('üîÑ Next steps:', 'info');
      log('1. Close this page', 'info');
      log('2. Refresh Phaeton AI CRM (Ctrl+R or F5)', 'info');
      log('3. Go to Settings > API Configuration', 'info');
      log('4. Enter your REAL API keys', 'info');
      log('5. Click Save', 'info');

      successMessage.style.display = 'block';
    }

    scanBtn.addEventListener('click', scanForTestCredentials);
    clearBtn.addEventListener('click', clearAllTestCredentials);

    // Auto-scan on load
    setTimeout(scanForTestCredentials, 500);
  </script>
</body>
</html>
