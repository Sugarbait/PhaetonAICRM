<!DOCTYPE html>
<html>
<head>
    <title>Diagnose Credentials</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; background: #2a2a2a; padding: 30px; border-radius: 10px; }
        button { background: #0066cc; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0052a3; }
        .success { background: #00cc44; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .error { background: #cc0000; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .info { background: #0066cc; padding: 15px; border-radius: 5px; margin: 15px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnose Credentials Storage</h1>
        <p>This tool will check localStorage for stored credentials.</p>

        <div id="output"></div>

        <button onclick="diagnoseCredentials()">Check Credentials</button>
        <button onclick="listAllKeys()">List All localStorage Keys</button>
        <button onclick="tryDecrypt()">Try Manual Decrypt</button>
    </div>

    <script>
        const userId = '10443bec-8797-4713-b2f7-384ef9285ca3'

        function output(message, type = 'info') {
            const div = document.getElementById('output')
            div.innerHTML = `<div class="${type}">${message}</div>` + div.innerHTML
        }

        function diagnoseCredentials() {
            output('üîç Checking credentials storage...', 'info')

            // Check if credentials exist
            const credKey = `userCredentials_${userId}`
            const credentials = localStorage.getItem(credKey)

            if (credentials) {
                output(`‚úÖ Credentials found in localStorage!

Key: ${credKey}
Length: ${credentials.length} characters
Format: ${credentials.substring(0, 50)}...

First 100 chars:
${credentials.substring(0, 100)}
`, 'success')
            } else {
                output(`‚ùå No credentials found for key: ${credKey}`, 'error')
            }

            // Check for emergency credentials
            const emergencyKey = 'emergencyCredentials_pierre@phaetonai.com'
            const emergencyCreds = localStorage.getItem(emergencyKey)
            if (emergencyCreds) {
                output(`‚úÖ Emergency credentials found!

Key: ${emergencyKey}
Value: ${emergencyCreds}`, 'success')
            }

            // Check for login stats
            const statsKey = `loginStats_${userId}`
            const stats = localStorage.getItem(statsKey)
            if (stats) {
                output(`üìä Login stats found:
${stats}`, 'info')
            }
        }

        function listAllKeys() {
            output('üìã All localStorage keys:', 'info')
            const keys = []
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i)
                const value = localStorage.getItem(key)
                keys.push(`${key} (${value.length} chars)`)
            }
            output(`Found ${keys.length} keys:\n${keys.join('\n')}`, 'info')
        }

        async function tryDecrypt() {
            const credKey = `userCredentials_${userId}`
            const encryptedString = localStorage.getItem(credKey)

            if (!encryptedString) {
                output('‚ùå No encrypted credentials found', 'error')
                return
            }

            output(`üîì Attempting manual decrypt...

Encrypted string format:
${encryptedString.substring(0, 200)}...

Checking format:
- Contains colons: ${encryptedString.includes(':')}
- Number of parts: ${encryptedString.split(':').length}
- Expected format: data:iv:tag:timestamp
`, 'info')

            // Try to parse the format
            if (encryptedString.includes(':')) {
                const parts = encryptedString.split(':')
                output(`üìä Parts breakdown:
Part 1 (data): ${parts[0]?.substring(0, 50)}...
Part 2 (iv): ${parts[1]?.substring(0, 50)}...
Part 3 (tag): ${parts[2]?.substring(0, 50)}...
Part 4 (timestamp): ${parts[3]}

Total parts: ${parts.length}
`, 'info')

                if (parts.length === 4) {
                    output('‚úÖ Format looks correct (4 parts)', 'success')
                } else {
                    output(`‚ö†Ô∏è Format may be incorrect (expected 4 parts, got ${parts.length})`, 'error')
                }
            } else {
                output('‚ùå No colons found - not in expected format', 'error')
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(diagnoseCredentials, 500)
        })
    </script>
</body>
</html>
