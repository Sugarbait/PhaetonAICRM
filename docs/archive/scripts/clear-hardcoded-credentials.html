<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clear Hardcoded Credentials - Phaeton AI CRM</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #0056b3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    .info {
      background: #e7f3ff;
      border: 1px solid #004085;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .credential-item {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #dc3545;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      min-height: 100px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Clear Hardcoded Credentials</h1>

    <div class="warning">
      <strong>‚ö†Ô∏è Warning:</strong> This will remove all hardcoded Retell AI credentials from your browser's localStorage.
    </div>

    <div class="success" id="successMessage">
      <strong>‚úÖ Success!</strong> Hardcoded credentials have been cleared!
    </div>

    <div style="margin-top: 20px;">
      <button id="scanBtn">üîç Scan for Hardcoded Credentials</button>
      <button class="danger" id="clearBtn">üóëÔ∏è Clear Hardcoded Credentials</button>
    </div>

    <div id="output">
      <p>Click "Scan" to detect hardcoded credentials...</p>
    </div>

    <div class="info">
      <h4>üìù Instructions:</h4>
      <ol>
        <li>Click <strong>"Scan for Hardcoded Credentials"</strong></li>
        <li>Click <strong>"Clear Hardcoded Credentials"</strong></li>
        <li>Refresh Phaeton AI CRM (localhost:3001)</li>
        <li>Go to Settings &gt; API Configuration and enter YOUR keys</li>
      </ol>
    </div>
  </div>

  <script>
    console.log('Script loaded');

    // Hardcoded credential values
    const HARDCODED_VALUES = {
      apiKey: 'key_c3f084f5ca67781070e188b47d7f',
      callAgentId: 'agent_447a1b9da540237693b0440df6',
      smsAgentId: 'agent_643486efd4b5a0e9d7e094ab99'
    };

    const output = document.getElementById('output');
    const scanBtn = document.getElementById('scanBtn');
    const clearBtn = document.getElementById('clearBtn');
    const successMessage = document.getElementById('successMessage');

    function log(message, isError = false) {
      const p = document.createElement('p');
      p.textContent = message;
      if (isError) p.style.color = 'red';
      output.appendChild(p);
      console.log(message);
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    function scanCredentials() {
      console.log('Scan button clicked');
      clearOutput();
      log('üîç Scanning localStorage...');

      let foundCount = 0;
      const detectedKeys = [];

      try {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key) continue;

          log(`Checking key: ${key}`);

          if (key.startsWith('settings_')) {
            const value = localStorage.getItem(key);
            if (!value) continue;

            try {
              const settings = JSON.parse(value);

              const hasHardcodedApiKey = settings.retellApiKey === HARDCODED_VALUES.apiKey;
              const hasHardcodedCallAgent = settings.callAgentId === HARDCODED_VALUES.callAgentId;
              const hasHardcodedSmsAgent = settings.smsAgentId === HARDCODED_VALUES.smsAgentId;

              if (hasHardcodedApiKey || hasHardcodedCallAgent || hasHardcodedSmsAgent) {
                foundCount++;
                log(`\n‚ùå FOUND hardcoded credentials in: ${key}`);
                if (hasHardcodedApiKey) log('  - Hardcoded API Key detected');
                if (hasHardcodedCallAgent) log('  - Hardcoded Call Agent ID detected');
                if (hasHardcodedSmsAgent) log('  - Hardcoded SMS Agent ID detected');

                detectedKeys.push(key);
              }
            } catch (parseError) {
              log(`Error parsing ${key}: ${parseError.message}`, true);
            }
          }
        }

        if (foundCount === 0) {
          log('\n‚úÖ No hardcoded credentials detected!');
        } else {
          log(`\n‚ö†Ô∏è Total: Found hardcoded credentials in ${foundCount} key(s)`);
        }

      } catch (error) {
        log(`Error during scan: ${error.message}`, true);
        console.error(error);
      }

      return detectedKeys;
    }

    function clearHardcodedCredentials() {
      console.log('Clear button clicked');

      if (!confirm('Are you sure you want to clear all hardcoded credentials?')) {
        return;
      }

      clearOutput();
      log('üóëÔ∏è Clearing hardcoded credentials...');

      let clearedCount = 0;

      try {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key || !key.startsWith('settings_')) continue;

          const value = localStorage.getItem(key);
          if (!value) continue;

          try {
            const settings = JSON.parse(value);
            let modified = false;

            if (settings.retellApiKey === HARDCODED_VALUES.apiKey) {
              delete settings.retellApiKey;
              modified = true;
              log(`  - Removed hardcoded API key from ${key}`);
            }

            if (settings.callAgentId === HARDCODED_VALUES.callAgentId) {
              delete settings.callAgentId;
              modified = true;
              log(`  - Removed hardcoded Call Agent ID from ${key}`);
            }

            if (settings.smsAgentId === HARDCODED_VALUES.smsAgentId) {
              delete settings.smsAgentId;
              modified = true;
              log(`  - Removed hardcoded SMS Agent ID from ${key}`);
            }

            if (modified) {
              localStorage.setItem(key, JSON.stringify(settings));
              clearedCount++;
            }
          } catch (parseError) {
            log(`Error processing ${key}: ${parseError.message}`, true);
          }
        }

        log(`\n‚úÖ Successfully cleared ${clearedCount} key(s)`);
        successMessage.style.display = 'block';

        alert(`‚úÖ Cleared hardcoded credentials from ${clearedCount} localStorage key(s).\n\nPlease refresh Phaeton AI CRM and configure your API keys in Settings.`);

      } catch (error) {
        log(`Error during clearing: ${error.message}`, true);
        console.error(error);
      }
    }

    // Attach event listeners
    scanBtn.addEventListener('click', function() {
      console.log('Scan clicked via addEventListener');
      scanCredentials();
    });

    clearBtn.addEventListener('click', function() {
      console.log('Clear clicked via addEventListener');
      clearHardcodedCredentials();
    });

    // Auto-scan on load
    console.log('Running auto-scan on page load');
    setTimeout(() => {
      scanCredentials();
    }, 500);
  </script>
</body>
</html>
